#!/usr/bin/python3
#Date: 2019/11/7
#Author: Saint Michael

from lxml import etree
import requests
import time
import os
import re


#数据提取
def Spider_exploit_db(response,responses,num):
	text = response.content.decode()
	selector = etree.HTML(text)
	#取标题
	title = selector.xpath('//h1[@class="card-title text-secondary text-center"]/text()')[0].strip()
	#取颜色
	color = selector.xpath('//i[@class="mdi mdi-24px mdi-check"]/@style')[0].split(':')[1].strip()
	if color != '#96b365':
		return
	#CVE编号
	cvename = selector.xpath('//h6[@class="stats-title"]/a/@href')[0].split('/')[-1]
	if not cvename:
		cvename = num
	#文件名
	filenames = responses.headers['Content-Disposition'].split('filename=')[1].replace('"','')
	Catalogname = CreateCatalog(title)
	filenames = filenames.split('.')[1]
	cvename = cvename+'.'+filenames
	cvename = re.sub(r'<|\\|/|>|:|\*|\?|\|',' ',cvename)
	DowloadPoc(Catalogname,cvename.strip(),responses)
	return title

#创建文件夹
def CreateCatalog(title):
	Catalog = os.getcwd()
	title =  re.sub(r'<|\\|/|>|:|\*|\?|\|',' ',title)
	os.mkdir(Catalog+"\\"+title)
	return Catalog+"\\"+title+"\\"

#下载POC
def DowloadPoc(CatalogName,cvename,responses):
	filename = CatalogName+cvename
	with open(filename,'wb') as f:
		f.write(responses.content)
	return

if __name__ == '__main__':

	url = 'https://www.exploit-db.com/'
	
	for i in range(1,47597):
		time.sleep(2)
		urla = url+"exploits/"+str(i)
		urlb = url+'download/'+str(i)

		headers = {
			'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0',
			'Referer': 'https://www.exploit-db.com/'
		}
		try:
			response = requests.get(url=urla,headers=headers,timeout=5)
			responses = requests.get(url=urlb,headers=headers,timeout=5)

		except:
			continue
		if response.status_code == 200 and responses.status_code ==200:
			print(Spider_exploit_db(response,responses,str(i)))
		else:
			continue
